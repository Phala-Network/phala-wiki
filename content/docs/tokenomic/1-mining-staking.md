---
title: "1 TEE Mining Staking"
---

<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$','$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };
  window.addEventListener('load', (event) => {
      document.querySelectorAll("mjx-container").forEach(function(x){
        x.parentElement.classList += 'has-jax'})
    });
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>


## Introduction

To secure the cloud of Workers and the jobs they are assigned, the network will set [Confidence Level]({{< relref "docs/khala-mining/1-3-confidential-level-evaluation#confidence-level-of-a-miner" >}}) for each worker’s CPU and will require ***Staking*** to enable mining. Each worker can only earn value $V$ if it first stakes a number of PHA tokens based on its CPU score, after which it can enter the mining system and start TEE Mining.

If a worker misbehaves or fails to respond, it will be punished by slashing the $V$, which strongly incentivizes participants to ensure their workers are running properly and disincentivizes attempts to cheat.


## TEE Mining Roles

| **Role** | **Description** | **Identifier** |
| :----: | :----: | :----: |
| **Worker**| A computing node; a CPU. Responsible for off-chain computation in the Phala network (in a private and secure enclave). | worker key |
| **Operator** | Authorized by a Worker to act as administrator, responsible for managing the Worker’s Mining. | operator key |
|**Owner** | A StakePool manager. Creates a StakePool address; responsible for the management of the pool and the Mining of any workers bound to the pool. | owner key |
|**StakePool**| A pool of Stake from a group of parties backing a group of Workers. Provides a middle layer of fund flow between Workers and Stakers; provides for on-chain management of TEE Mining stake. | pid (automatically generated by the system) |
|**Staker**| A PHA-holding address. Can participate in Phala TEE Mining through Staking a Worker or StakePool. | staker key |


## Role Relationships

| | **Operator** | **Owner** | **Staker** |
| :----: | :----: | :----: | :----: |
| **Worker** | A Worker is managed by one Operator; an Operator can manage multiple Workers. | When the Operator of a Worker is the Owner of a Pool, the Pool can stake PHA for this Worker. | **/** |
| **StakePool** | The Owner of a Pool is the Operator for the Pool’s Workers. The Pool can stake the Worker as required. | Each pool is bound to one Owner; an Owner can create multiple Pools. | A Staker can stake to multiple Pools; each Pool can have multiple Stakers. |


## The Relationship between Worker and StakePool

![](/images/docs/tokenomic/worker-stakepool.png)
<center>Figure 1 Worker-StakePool</center>

As shown on Figure 1，

- When a Worker (such as **a**, **b**, or **c**) is created, it needs to authorize a particular Operator address (such as **A**) to manage the computing node;
- An Owner (such as **A**) can create one or more StakePools (such as Pool **1**);
- Because **A** is both the Owner of Pool **1** and the Operator of Workers {**a**, **b**, **c**}, Workers {**a**, **b**} can be bound to Pool **1**. The PHA in Pool **1** can then be allocated to Workers (**a**, **b**) as their Stake to enable mining. Similarly, **A** can bind worker **c** to Pool **2** and use Stake in Pool **2** to enable **c**’s mining;
- Similarly, **B** is the Owner of Pool **3**, so the Workers {**d**, **e**} which are managed by **B** can be bound to Pool **3**.

> **Impossible relationships:**
> - Worker **c** authorized **A** as Operator, so it cannot also authorize **B** at the same time. If Worker **c** wants to transfer control to **B**, it must first stop mining for **A**;
> - Pool **2** has been created by and is bound to **A**, therefore **B** cannot have a relationship with Pool **2**. Owner **B** can create and manage Pool **3** by itself.


## Assignment of Stake from Pools to Workers

![](/images/docs/tokenomic/staker-worker-1.png)
<center>Figure 2.1 Original Staking</center>

As shown in Figure 2.1, let’s assume that Owner **A** manages Pool **1**, and Pool **1** has bound Workers {**a**, **b**, **c**}; Owner **B** manages Pool **3**, and Pool **3** has bound Workers {**d**, **e**}, and:
- **A** sets a 50% commission rate for Pool **1**, and personally stakes 20k PHA to Pool **1**;
- **B** sets a 40% commission rate for Pool **3**, and personally stakes 10k PHA to Pool **3**.

Assume that the minimum stake amounts (from CPU scoring) for workers **a**, **b**, **c**, **d**, **e** are: 10k, 12.3k, 10k, 5k and 5k. We can see that Pool **1** does not have enough to stake all the Workers that are bound, but Pool **3** has enough to stake their Workers.

| **StakePool** | **Total PHA in Pool** | **Workers** | **Min Stake Needed for All Workers** |
| :----: | :----: | :----: | :----: |
| **1** | 20k | **a**: 10k, **b**: 12.3k, **c**: 10k | 32.3k |
| **3** | 10k | **d**: 5k, **e**: 5k | 10k |

Then their best strategies are:
- Pool **1** stakes 12.3k to **b** and sets **b** to start working;
- Pool **3** stakes 5k to each of **d** and **e**, and sets both **d** and **e** to start working.

We know that some people have the capacity to provide Worker CPUs, but do not have funds to stake them, while other people have ample funds to stake but don’t have the capacity to run Workers. In order to ensure as many suitable Workers are adequately staked as possible, we create the StakePool protocol to allow third-party Stakers to add PHA to Pools which can be assigned to stake various Workers.

Suppose Staker **①** and Staker **④** stake 0.3k and 13k respectively to Pool **1**, and Staker **②** and Staker **③** stake 0.5k and 20k respectively to Pool **3**:

![](/images/docs/tokenomic/staker-worker-2.png)
<center>Figure 2.2 Staking after Stakers participate</center>

As shown in Figure 2.2, we can see that both Pool **1** and Pool **3** can now meet minimum stake requirements for all workers that are bound, and they can even over-stake the workers at this time. (Over-staking increases mining rewards, but each additional PHA brings fewer additional returns. It is more profitable to spread stake over many workers than to use it to overstake a small number of workers.)

| **StakePool** | **Total PHA in Pool** | **Workers** | **Worker Minimum Stake Amount** | **Possible Stake Allocation** |
| :----: | :----: | :----: | :----: | :----: |
| **1** | 33.3k | **a** | 10k | 10k |
| **1** | 33.3k | **b** | 12.3k | 13.3k (overstaked) |
| **1** | 33.3k | **c** | 10k | 10k |
| **3** | 30.5k | **d** | 5k | 15k (overstaked) |
| **3** | 30.5k | **e** | 5k | 15k (overstaked) |

At this time, the PHA in the StakePools will be divided into two states: ***Deposited*** (staked) and ***Free*** (not staked).

| **StakePool** | **Deposited** | **Free** |
| :----: | :----: | :----: |
| **1** | 33.3k | 0 |
| **3** | 30k | 0.5k |

In real-world cases, each Pool Owner can set a maximum stake amount for the Pool to prevent the pool's stake share from being maliciously diluted:
- When the total PHA in the pool is below the maximum stake amount, any Staker can join by contributing PHA;
- When the total PHA amount has reached the maximum stake amount, additional PHA will not be accepted.


## Reward Settlement Flow

When TEE mining rewards are generated, the mining module will generate statistics and perform settlements based on the current network Workers and distribute the rewards for each Worker to their corresponding StakePool. The PHA rewards credited to the StakePool will be automatically divided into two parts based on the commission rate of the pool. The commission portion is deposited into the pool’s Owner address, and the remainder is deposited into the Stakers’ addresses. The Stakers’ shares of the reward are apportioned based on their relative share of the Pool’s total stake.

In the example below, we assume that at block 42 the Khala network produced 64 PHA rewards for Workers. Assume our five Workers {**a**, **b**, **c**, **d**, **e**} are the entire network, are all online and working to receive their shares, and that their accumulated $V$ values are proportional to their staked amounts as listed above. The TEE Mining module will calculate the rewards due per Worker {**a**, **b**, **c**, **d**, **e**}, recording them into Pool **1** and Pool **3** as Pool Reward, will settle commission amounts due to the Owners for running the workers and the pool, and will apportion the remaining amount as Pool Revenue to all Stakers in the Pool based on their share of the Pool’s Stake, as follows.

![](/images/docs/tokenomic/reward-pool.png)
<center>Figure 3 Reward distribution</center>

The settlement formula for the Owner and StakePool portions is:
- $Owner\ Commission = Pool\ Reward * commission\ rate$
- $Pool\ Revenue = Pool\ Reward * (1 - commission\ rate)$

The Pool Revenue is allocated to each Staker based on their individual Pool Share (their share of the total pool):
- $Pool\ Share = Staker’s\ stake / Pool\ total\ stake$

An individual Staker’s revenue allotment can be calculated as:
- $Staker’s\ Reward = Pool\ Revenue * Pool\ Share$

Which is the same as:
- $Staker’s\ Reward = (Pool\ Reward * (1 - commission\ rate)) * (Staker’s\ stake / Pool\ stake)$

If the Owner themselves also stake, they will earn their share of the Pool Revenue as well as the Owner Commission.

The Pool total stake includes the sum of ***Deposited*** (staked) and ***Free*** (not staked).

With Owners, Pools, and Workers as shown in Figure 3, and the 64 PHA from block 42 allocated per Worker as shown in the figure, the result is 34 PHA to Pool **1** and 30 PHA to Pool **3**.

The Owners receive their Commission portion for running the pools and Workers as follows:

| **Owner** | **Pool Reward** | **Commission Rate** | **Owner Commission** | **Pool Revenue** |
| :----: | :----: | :----: | :----: | :----: |
| **A** | 34 PHA | 50% | 17 PHA | 17 PHA |
| **B** | 30 PHA | 40% | 12 PHA | 18 PHA |

The remaining Pool Reward is now Pool Revenue to be paid out to all Stakers based on Pool Share (again, if the Owners Staked, then they are also Stakers and get paid their share.) In our example, this plays out like this:

| **Staker** | **StakePool** | **Pool Revenue** | **Staker's Stake / Pool Total Stake** | **Staker's Pool Share** | **Rewards** |
| :----: | :----: | :----: | :----: | :----: | :----: |
| Owner **A** | **1** | 17 PHA | 20k / 33.4k | 59.9% | 10.18 PHA|
| Owner **B** | **3** | 18 PHA | 10k / 30.5k | 32.8% | 5.9 PHA|
| Staker **①** | **1** | 17 PHA | 0.3k / 33.4k | 0.9% | 0.15 PHA |
| Staker **②** | **3** | 18 PHA | 0.5k / 30.5k | 1.6% | 0.29 PHA |
| Staker **③** | **3** | 18 PHA | 20k / 30.5k | 65.6% | 11.81 PHA |
| Staker **④** | **1** | 17 PHA | 13k / 33.4k | 38.9% | 6.61 PHA |


## Pool Exit Stake Settlements

If the Owner wants to quit mining and withdraw all their own staked PHA, they first suspend mining. After the stop is initiated, the funds that were staking those Workers will undergo a 7-day freeze period in the StakePool, after which the balance will be unfrozen and will be returned. The Owner cannot withdraw other Stakers’ deposits.

![](/images/docs/tokenomic/withdraw-1.png)
<center>Figure 4.1 Withdraw example</center>

As shown in Figure 4.1, when the Owner cancels mining, the StakePool immediately suspends computing for all Workers and associated stakes immediately enter a ***Freeze Period***. After 7 days, the PHA contributed by for Owner **A**, Staker **①**, and Staker **④** will be refunded in full.

Stakers can request withdrawal of their funds at any time, and if there are idle funds in the StakePool (***Free***), they will receive their withdrawal immediately. However, if Staker's withdrawal amount is greater than the idle funds in StakePool (***Free***), Staker will immediately obtain the Free funds and the remainder of the withdrawal will need to wait:

![](/images/docs/tokenomic/withdraw-2.png)
<center>Figure 4.2 Withdraw when there is not enough Free PHA</center>

As shown in Figure 4.2, Staker **③** initially staked 20k in Pool **3**. When they submit a withdrawal for 10k of their stake, Pool **3** immediately sent the 0.5k balance of the Free PHA to Staker **③**. The remaining 9.5k of staked PHA will wait for the following:
- A 7-day buffer period begins at the initial withdrawal. During this period, if new PHA are added to the StakePool as Free or if some Worker Mining is stopped (which will free the funds staking that miner), then PHA will be unlocked immediately to the Staker who initiated the withdrawal. There may be multiple deposits or Worker stoppages until enough PHA is Free to meet the withdrawal;
- If the withdrawal request is still not met after 7 days, all Workers in this Pool will be automatically stopped and enter a 7-day freeze period which cannot be interrupted by anyone. After 7 days, the withdrawal transaction will be completed;
- In other words, when a Staker initiates a withdrawal, they will receive their funds in no more than 14 days, but may receive some or all of their funds in 7 days or less, depending on Free funds.

Assume that more funds are contributed to the StakePool:

![](/images/docs/tokenomic/withdraw-3.png)
<center>Figure 4.3 Withdraw after more staking</center>

- As shown in Figure 4.3, after Staker **②** stakes an additional 5k PHA to Pool **3**, the Pool’s Free funds increased by 5k, and Staker **③** immediately receives an additional 5k towards their withdrawal;
- If, after waiting 7 days, the necessary 4.5k of funds are still not Free, the system is forced to terminate all the mining activities of Pool **3**, and will automatically send the remaining 4.5k to Staker **③** after the 7-day unfreeze period.

Summarizing:
- When the actual StakePool Owner initiates the suspension of all mining or cancels all Staking to dissolve the pool, withdrawal of all Stakes will be triggered. There will be a 7-day unfreeze period after which all PHA in the StakePool will be refunded to the Stakers;
- When a Staker initiates a withdrawal of their own Stake, the system will determine whether the Pool has Free funds, and if so, it automatically return them to the Staker;
- If there is insufficient Free funds, the Owner of the Pool has 7 days to arrange for the PHA that Staker wants returned (from an existing or new Staker), or else to free funds by idling Worker(s) to Free their allotted stake. If the replenishment of funds can meet the withdrawal request, the remaining Workers will not be interrupted;
- If Free funds are not sufficient to meet the withdrawal, the system will be forced to suspend all mining activities in this Pool in order to complete the withdrawal for the Staker (7 days after all Workers are stopped).
